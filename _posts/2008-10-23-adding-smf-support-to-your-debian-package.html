---
layout: post
title: Adding SMF support to your debian package
date: 2008-10-23 16:22:53.000000000 +05:30
categories:
- Nexenta
- Opensolaris
- tech
tags:
- debhelper
- dh_installsmf
- Nexenta
- smf
status: publish
type: post
published: true
meta:
  _edit_last: '1'
author:
  login: admin
  email: anil.verve@gmail.com
  display_name: admin
  first_name: ''
  last_name: ''
---
<p>Services in Nexenta are handled using <a href="http://www.sun.com/bigadmin/content/selfheal/smf-quickstart.jsp" target="_blank">solaris SMF</a>. This makes it very easy to start and stop services; you dont have to worry about it's dependency on other services, which is taken care of by SMF automatically. This <a href="http://docs.alkaloid.net/index.php/SMF_Cheatsheet" target="_blank">cheetsheet</a> lists how easy it is to use SMF.</p>
<p><strong>dh_installsmf</strong></p>
<p><em>dh_installsmf</em> is one of Nexenta's addition to Debian's debhelper scripts. This makes it trivial to add SMF support in a debian package that installs a service at /etc/init.d/&amp;lt;service&amp;gt;</p>
<p>We'll take a look at how we can add support to such a package.</p>
<p><strong>XML Manifest file<br />
</strong></p>
<p>The SMF framework requires a manifest file, which is an XML file, that provides information regarding the service. This information includes the services that this particular service depends on (or configurations files, etc).</p>
<p>It also lists the commands that need to be run to enable, disable the service, or to set various other parameters. The format of the manifest file is explained <a href="http://www.sun.com/software/solaris/howtoguides/smfmanifesthowto.jsp" target="_blank">here</a>.</p>
<p>The Blastwave package has a good collection of <a href="http://www.blastwave.org/smf/manifests.php" target="_blank">manifest files</a> for various packages. Lets take a look at the manifest for <a href="/incoming/apache2.xml">apache2</a>:</p>
<blockquote><p>&lt;?xml version="1.0"?&gt;<br />
&lt;!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1"&gt;</p>
<p>&lt;service_bundle type="manifest" name="apache2"&gt;<br />
&lt;service name="network/apache2" type="service" version="4"&gt;<br />
&lt;create_default_instance enabled="false"/&gt;<br />
&lt;single_instance/&gt;</p>
<p>&lt;!-- First of all, if the config file is not present,<br />
then we needn't bother with anything else.Â  --&gt;<br />
&lt;dependency name="config-file" grouping="require_all" restart_on="none" type="path"&gt;<br />
&lt;service_fmri value="file:///etc/apache2/apache2.conf"/&gt;<br />
&lt;/dependency&gt;</p>
<p>&lt;!-- If there's no network, then there's no point in running --&gt;<br />
&lt;dependency name="loopback" grouping="require_all" restart_on="error" type="service"&gt;<br />
&lt;service_fmri value="svc:/network/loopback:default"/&gt;<br />
&lt;/dependency&gt;<br />
&lt;dependency name="physical" grouping="require_all" restart_on="error" type="service"&gt;<br />
&lt;service_fmri value="svc:/network/physical:default"/&gt;<br />
&lt;/dependency&gt;<br />
&lt;dependency name="fs-local" grouping="require_all" restart_on="none" type="service"&gt;<br />
&lt;service_fmri value="svc:/system/filesystem/local"/&gt;<br />
&lt;/dependency&gt;<br />
&lt;exec_method type="method" name="start" exec="/lib/svc/method/apache2 start" timeout_seconds="60"/&gt;<br />
&lt;exec_method type="method" name="stop" exec="/lib/svc/method/apache2 stop" timeout_seconds="60"/&gt;<br />
&lt;exec_method type="method" name="refresh" exec="/lib/svc/method/apache2 refresh" timeout_seconds="60"/&gt;<br />
&lt;stability value="Unstable"/&gt;<br />
&lt;template&gt;<br />
&lt;common_name&gt;<br />
&lt;loctext xml:lang="C"&gt;Apache2 web server&lt;/loctext&gt;<br />
&lt;/common_name&gt;<br />
&lt;documentation&gt;<br />
&lt;manpage title="apache2" section="7"/&gt;<br />
&lt;doc_link name="apache.org" uri="http://httpd.apache.org/docs/2.0"/&gt;<br />
&lt;/documentation&gt;<br />
&lt;/template&gt;<br />
&lt;/service&gt;<br />
&lt;/service_bundle&gt;</p></blockquote>
<p>In the above file, we see that apache2 has defined the following dependencies:</p>
<ul>
<li>The file <em>/etc/apache2/apache2.conf</em></li>
<li>The network service (and the physical interface being up)</li>
<li>The local filesystem</li>
</ul>
<p>It also defines three methods <em>start</em>, <em>stop</em> and <em>refresh</em>, which are commands for this particular service (start the webserver, stop the webserver, reload the webserver). They call a script /lib/svc/method/apache2, which brings us to dh_installsmf</p>
<p><strong>debian/rules</strong></p>
<p>The service script <em>/lib/svc/method/&amp;lt;package&amp;gt;</em> is generated by dh-installsmf, so when you create an SMF manifest file for Nexenta, make sure you call that file. dh_installsmf will create a script <em>/lib/svc/method/&amp;lt;package&amp;gt;</em> which is a wrapper over the /etc/init.d/&amp;lt;package&amp;gt; file.</p>
<p>So in our case the <em>debian/rules</em> file in the apache2 package will be modified as</p>
<blockquote><p>[snip]</p>
<p>rm -f debian/apache2-utils/usr/share/doc/apache2-utils/NEWS.Debian<br />
dh_installinit -a --no-start -r --name=apache2 -- defaults 91 09<br />
<strong>dh_installsmf --service apache2 --manifest debian/apache2.xml -papache2.2-common</strong><br />
dh_installcron -a -r --name=apache2<br />
if [ "$(LSB_RELEASE)" = "Ubuntu" ]; then \<br />
dh_strip -a; \<br />
else \<br />
dh_strip -a --dbg-package=apache2-dbg -Napache2-mpm-worker -Napache2-mpm-event -Napache2-mpm-prefork -Napache2-dbg; \<br />
fi<br />
dh_link -a<br />
dh_compress -a<br />
[snip]</p></blockquote>
<p>The --service argument gives the name of the service, the --manifest points to the manifest file and -p tells it which package the smf changes go into. This is basically the package that provides the <em>/etc/init.d/&amp;lt;package&amp;gt;</em> file.</p>
<p>And that is how we generate SMFed debian packages.</p>
